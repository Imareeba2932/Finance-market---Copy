{% extends 'base.html' %}
{% block content %}
<div class="dashboard-grid">
  <header class="dashboard-header d-flex align-items-start justify-content-between">
    <div>
      <h1 class="page-title">Global Finance Dashboard</h1>
      <p class="text-muted mb-2">Clean, interactive analytics — refined insights and quick filters</p>
      <div class="small text-muted">Updated: {{ last_updated or '—' }}</div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{{ url_for('dashboard') }}">Reset Filters</a>
      <a class="btn btn-primary" href="#explore">Explore</a>
    </div>
  </header>

  <aside class="dashboard-sidebar card card-filter p-3 sticky-sidebar">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h6 class="mb-0">Filters</h6>
      <span class="small text-muted">Refine view</span>
    </div>

    <form method="get">
      <div class="mb-3">
        <label class="form-label">Countries</label>
        <select class="form-select" name="country" multiple size="6">
          {% for c in meta.countries %}
            <option value="{{ c }}" {% if c in selected.countries %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
        <div class="form-text">Use Ctrl/Cmd to multi-select</div>
      </div>

      <div class="mb-3 row gx-2">
        <div class="col-12">
          <label class="form-label">Credit Ratings</label>
          <select class="form-select" name="rating" multiple size="4">
            {% for r in meta.credit_ratings %}
              <option value="{{ r }}" {% if r in selected.ratings %}selected{% endif %}>{{ r }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="row g-2 mb-3">
        <div class="col-6">
          <label class="form-label">From</label>
          <input class="form-control" type="date" name="start_date" value="{{ selected.start_date or '' }}" />
        </div>
        <div class="col-6">
          <label class="form-label">To</label>
          <input class="form-control" type="date" name="end_date" value="{{ selected.end_date or '' }}" />
        </div>
      </div>

      <div class="d-grid">
        <button class="btn btn-primary">Apply</button>
      </div>
    </form>
  </aside>

  <main class="dashboard-main">
    {% if kpis %}
    <section class="kpi-row">
      {% for label, value in kpis.items() %}
      <div class="kpi-card card">
        <div class="card-body">
          <div class="kpi-label">{{ label }}</div>
          <div class="kpi-value">{{ value }}</div>
          <div class="kpi-sub text-muted">{% if kpi_details and kpi_details[label] %}{{ kpi_details[label] }}{% endif %}</div>
        </div>
      </div>
      {% endfor %}
    </section>
    {% endif %}

    <section id="explore" class="row g-3">
      <div class="col-xl-12">
        <div class="card">
          <div class="card-header">Market Cap by Country (T$)</div>
          <div class="card-body">
            {{ market_cap_div|safe if market_cap_div else '<div class="text-muted">No data</div>' }}
            <div class="chart-insights mt-3">
              <h6>Key insight</h6>
              <p class="text-muted">{% if market_cap_insight %}{{ market_cap_insight }}{% else %}Top countries drive the majority of market capitalization; look at concentration and sector exposure.{% endif %}</p>
              <div class="small text-muted">Suggested next step: Compare market cap share vs. GDP for valuation context.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-xl-6">
        <div class="card">
          <div class="card-header">Index vs Daily Change</div>
          <div class="card-body">
            {{ rel_scatter1_div|safe if rel_scatter1_div else '<div class="text-muted">No data</div>' }}
            <div class="chart-insights mt-3">
              <h6>Interpretation</h6>
              <p class="text-muted">{% if rel_scatter1_insight %}{{ rel_scatter1_insight }}{% else %}Scatter plots highlight relationships between absolute index level and daily volatility.{% endif %}</p>
            </div>
          </div>
        </div>
      </div>

      <div class="col-xl-6">
        <div class="card">
          <div class="card-header">Policy Rate vs 10Y Yield</div>
          <div class="card-body">
            {{ rel_scatter2_div|safe if rel_scatter2_div else '<div class="text-muted">No data</div>' }}
            <div class="chart-insights mt-3">
              <h6>Context</h6>
              <p class="text-muted">{% if rel_scatter2_insight %}{{ rel_scatter2_insight }}{% else %}Look for outliers where yields diverge significantly from policy rates — potential market stress signals.{% endif %}</p>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>
{% endblock %}